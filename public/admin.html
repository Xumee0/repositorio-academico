<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Panel Admin | Repositorio Acad√©mico</title>
  <link rel="stylesheet" href="assets/css/app.css">
  <style>
    /* Estilos adicionales para el m√≥dulo de promociones */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: var(--card-bg, white);
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .modal-header {
      padding: 20px 25px;
      border-bottom: 1px solid var(--border, #e5e7eb);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 1.25rem;
      color: var(--text, #1f2937);
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--muted, #6b7280);
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-close:hover {
      color: var(--text, #1f2937);
    }
    
    .modal-body {
      padding: 25px;
    }
    
    .modal-footer {
      padding: 20px 25px;
      border-top: 1px solid var(--border, #e5e7eb);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text, #1f2937);
    }
    
    .form-group .hint {
      font-size: 0.85rem;
      color: var(--muted, #6b7280);
      margin-top: 5px;
    }
    
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .alert-info {
      background: #dbeafe;
      color: #1e40af;
      border-left: 4px solid #3b82f6;
    }
    
    .alert-warning {
      background: #fef3c7;
      color: #92400e;
      border-left: 4px solid #f59e0b;
    }
    
    .alert-danger {
      background: #fee2e2;
      color: #991b1b;
      border-left: 4px solid #ef4444;
    }
    
    .alert-success {
      background: #d1fae5;
      color: #065f46;
      border-left: 4px solid #10b981;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted, #6b7280);
    }
    
    .empty-state .icon {
      font-size: 4rem;
      opacity: 0.3;
      margin-bottom: 20px;
    }
    
    .btn-group {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    
    .modal-danger .modal-header {
      background: #ef4444;
      color: white;
    }
    
    .modal-danger .modal-close {
      color: white;
    }
    
    .badge-count {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    textarea.input {
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
    }
  </style>
</head>
<body>
<div class="container">
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-badge">RA</div>
      <div>
        <div class="brand-title">Administrador</div>
        <div class="brand-sub">Gesti√≥n institucional</div>
      </div>
    </div>

    <div class="nav">
      <button id="navHome" class="active" onclick="show('home')">üìä Dashboard</button>
      <button id="navProyectos" onclick="show('proyectos')">üìö Proyectos</button>
      <button id="navPromociones" onclick="show('promociones')">üéì Promociones</button>
      <button id="navDescargas" onclick="show('descargas')">üì• Descargas</button>
      <button class="danger btn" style="margin-top:8px;" onclick="logout()">üö™ Cerrar sesi√≥n</button>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="search">
        <span style="color:var(--muted)">üîé</span>
        <input id="q" placeholder="Buscar..." oninput="applyFilter()">
      </div>
      <button class="btn warning" onclick="toggleTheme()">üåì Tema</button>
    </div>

    <!-- SECCI√ìN: DASHBOARD -->
    <section id="home">
      <div class="grid">
        <div class="card col-3">
          <h3>Promociones</h3>
          <div class="kpi" id="kpiPromo">‚Äî</div>
          <div class="hint">Registradas</div>
        </div>
        <div class="card col-3">
          <h3>Especialidades</h3>
          <div class="kpi" id="kpiEsp">‚Äî</div>
          <div class="hint">Activas</div>
        </div>
        <div class="card col-3">
          <h3>Proyectos</h3>
          <div class="kpi" id="kpiProy">‚Äî</div>
          <div class="hint">Totales</div>
        </div>
        <div class="card col-3">
          <h3>Memorias</h3>
          <div class="kpi" id="kpiMem">‚Äî</div>
          <div class="hint">Subidas</div>
        </div>

        <div class="card col-12">
          <h3>Resumen</h3>
          <div style="color:var(--muted); font-size:13px;">
            Desde este panel puedes ver todos los proyectos, gestionar promociones, descargar memorias t√©cnicas por especialidad/promoci√≥n, 
            y generar reportes Excel generales.
          </div>
        </div>
      </div>
    </section>

    <!-- SECCI√ìN: PROYECTOS -->
    <section id="proyectos" style="display:none;">
      <div class="card">
        <h3>Todos los Proyectos</h3>
        
        <div style="margin-bottom:16px; display:flex; gap:12px; flex-wrap:wrap;">
          <select class="input" id="filtroPromocion" onchange="applyFilter()" style="width:auto;">
            <option value="">Todas las promociones</option>
          </select>
          <select class="input" id="filtroEspecialidad" onchange="applyFilter()" style="width:auto;">
            <option value="">Todas las especialidades</option>
          </select>
        </div>

        <table class="table" id="tblProy">
          <thead>
            <tr>
              <th>Promoci√≥n</th>
              <th>Especialidad</th>
              <th>Tema/Proyecto</th>
              <th>Tutor</th>
              <th>Estado</th>
              <th>Memoria</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- SECCI√ìN: PROMOCIONES -->
    <section id="promociones" style="display:none;">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <div>
            <h3 style="margin: 0;">üéì Gesti√≥n de Promociones</h3>
            <p style="color: var(--muted); font-size: 0.9rem; margin-top: 5px;">
              Administra las promociones del repositorio acad√©mico
            </p>
          </div>
          <button class="btn primary" onclick="mostrarModalCrear()">
            ‚ûï Nueva Promoci√≥n
          </button>
        </div>

        <div id="alertContainer"></div>

        <div id="loadingPromocion" style="text-align: center; padding: 40px;">
          <div class="spinner"></div>
          <p style="margin-top: 15px; color: var(--muted);">Cargando promociones...</p>
        </div>

        <div id="promocionesContainer" style="display: none;">
          <table class="table" id="tablaPromociones">
            <thead>
              <tr>
                <th>A√±o</th>
                <th>Descripci√≥n</th>
                <th style="text-align: center;">Proyectos</th>
                <th>Fecha Creaci√≥n</th>
                <th style="text-align: right;">Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div id="emptyState" style="display: none;">
          <div class="empty-state">
            <div class="icon">üìÅ</div>
            <h3>No hay promociones registradas</h3>
            <p>Comienza creando tu primera promoci√≥n</p>
            <button class="btn primary" onclick="mostrarModalCrear()" style="margin-top: 20px;">
              ‚ûï Crear Primera Promoci√≥n
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- SECCI√ìN: DESCARGAS -->
    <section id="descargas" style="display:none;">
      <div class="card">
        <h3>Descargar Memorias T√©cnicas</h3>
        <p style="color:var(--muted); font-size:13px;">
          Selecciona una especialidad y promoci√≥n para descargar todas las memorias t√©cnicas en un archivo ZIP.
        </p>

        <div class="grid">
          <div class="card col-6">
            <label>Especialidad</label>
            <select class="input" id="selEsp"></select>
          </div>
          <div class="card col-6">
            <label>Promoci√≥n</label>
            <select class="input" id="selPromo"></select>
          </div>
        </div>

        <button class="btn success" onclick="descargarMemoriasPorFiltro()">
          üì• Descargar ZIP
        </button>
      </div>

      <div class="card" style="margin-top:20px;">
        <h3>Descarga General</h3>
        <p style="color:var(--muted); font-size:13px;">
          Descarga un Excel con informaci√≥n completa de todos los proyectos del sistema.
        </p>
        <button class="btn success" onclick="descargarExcelGeneral()">
          üìä Descargar Excel General
        </button>
      </div>
    </section>

  </main>
</div>

<!-- TOAST DE NOTIFICACIONES -->
<div class="toast" id="toastBox">
  <strong id="toastTitle">Aviso</strong>
  <p id="toastMsg"></p>
</div>

<!-- MODAL: CREAR/EDITAR PROMOCI√ìN -->
<div class="modal" id="modalPromocion">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitulo">‚ûï Nueva Promoci√≥n</h3>
      <button class="modal-close" onclick="cerrarModal('modalPromocion')">&times;</button>
    </div>
    <div class="modal-body">
      <form id="formPromocion" onsubmit="guardarPromocion(event)">
        <input type="hidden" id="promocionId">
        
        <div class="form-group">
          <label for="anio">üìÖ A√±o *</label>
          <input 
            type="number" 
            class="input" 
            id="anio" 
            placeholder="Ej: 2024" 
            min="2000" 
            max="2100"
            required
          >
          <div class="hint">A√±o de graduaci√≥n de la promoci√≥n</div>
        </div>

        <div class="form-group">
          <label for="descripcion">üìù Descripci√≥n (Opcional)</label>
          <textarea 
            class="input" 
            id="descripcion" 
            rows="3" 
            placeholder="Ej: Promoci√≥n del Bicentenario"
          ></textarea>
          <div class="hint">Informaci√≥n adicional sobre la promoci√≥n</div>
        </div>

        <div class="alert alert-info">
          <span>‚ÑπÔ∏è</span>
          <small>Los campos marcados con * son obligatorios</small>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn" onclick="cerrarModal('modalPromocion')">
        ‚ùå Cancelar
      </button>
      <button type="button" class="btn primary" onclick="guardarPromocion()">
        üíæ Guardar
      </button>
    </div>
  </div>
</div>

<!-- MODAL: CONFIRMAR ELIMINACI√ìN -->
<div class="modal modal-danger" id="modalEliminar">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚ö†Ô∏è Confirmar Eliminaci√≥n</h3>
      <button class="modal-close" onclick="cerrarModal('modalEliminar')">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="idEliminar">
      <p style="margin-bottom: 15px;">
        ¬øEst√°s seguro de que deseas eliminar la promoci√≥n <strong id="promocionEliminar"></strong>?
      </p>
      <div class="alert alert-warning">
        <span>‚ö†Ô∏è</span>
        <small>Solo se pueden eliminar promociones sin proyectos asociados.</small>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn" onclick="cerrarModal('modalEliminar')">
        Cancelar
      </button>
      <button type="button" class="btn danger" onclick="confirmarEliminar()">
        üóëÔ∏è Eliminar
      </button>
    </div>
  </div>
</div>

<script src="assets/js/api.js"></script>
<script src="assets/js/ui.js"></script>
<script>initTheme();</script>

<script>
requireAuth('admin');

let cache = { proyectos:[], especialidades:[], promociones:[] };

// ============================================
// NAVEGACI√ìN ENTRE SECCIONES
// ============================================
function setActive(btnId){
  ['navHome','navProyectos','navPromociones','navDescargas'].forEach(id=>$(id).classList.remove('active'));
  $(btnId).classList.add('active');
}

function show(section){
  ['home','proyectos','promociones','descargas'].forEach(s=>$(s).style.display='none');
  $(section).style.display='block';
  
  const navMap = {
    'home': 'navHome',
    'proyectos': 'navProyectos',
    'promociones': 'navPromociones',
    'descargas': 'navDescargas'
  };
  
  setActive(navMap[section]);
  
  if(section === 'proyectos') applyFilter();
  if(section === 'promociones') cargarPromociones();
}

// ============================================
// FILTROS DE PROYECTOS
// ============================================
function applyFilter(){
  const q = $('q').value.trim().toLowerCase();
  const promoFiltro = $('filtroPromocion')?.value || '';
  const espFiltro = $('filtroEspecialidad')?.value || '';
  
  const p = cache.proyectos.filter(x => {
    const matchText = `${x.tema_proyecto} ${x.tutor} ${x.especialidad} ${x.promocion} ${x.estado}`.toLowerCase().includes(q);
    const matchPromo = !promoFiltro || String(x.promocion) === promoFiltro;
    const matchEsp = !espFiltro || x.especialidad === espFiltro;
    return matchText && matchPromo && matchEsp;
  });
  
  $('tblProy').querySelector('tbody').innerHTML = p.map(x=>`
    <tr>
      <td>${x.promocion}</td>
      <td>${x.especialidad}</td>
      <td><strong>${escapeHtml(x.tema_proyecto)}</strong></td>
      <td>${escapeHtml(x.tutor)}</td>
      <td>${statusBadge(x.estado)}</td>
      <td>${x.nombre_archivo ? 
        `<a class="badge" href="/uploads/${encodeURIComponent(x.nombre_archivo)}" target="_blank">Ver PDF</a>` : 
        '<span class="badge warn">Sin archivo</span>'
      }</td>
    </tr>
  `).join('');
}

// ============================================
// CARGAR DATOS INICIALES
// ============================================
async function loadAll(){
  try{
    cache.proyectos = await apiFetch('/proyectos');
    cache.especialidades = await apiFetch('/tutores/especialidades');
    cache.promociones = await apiFetch('/promociones');

    $('kpiProy').textContent = cache.proyectos.length;
    $('kpiMem').textContent = cache.proyectos.filter(x => x.nombre_archivo).length;
    $('kpiEsp').textContent = cache.especialidades.length;
    $('kpiPromo').textContent = cache.promociones.length;

    // Llenar filtros de proyectos
    $('filtroPromocion').innerHTML = '<option value="">Todas las promociones</option>' +
      cache.promociones.map(p => `<option value="${p.anio}">${p.anio}</option>`).join('');
    
    $('filtroEspecialidad').innerHTML = '<option value="">Todas las especialidades</option>' +
      cache.especialidades.map(e => `<option value="${escapeHtml(e.nombre)}">${escapeHtml(e.nombre)}</option>`).join('');

    // Llenar selectores de descarga
    $('selEsp').innerHTML = cache.especialidades.map(e => 
      `<option value="${e.id}">${escapeHtml(e.nombre)}</option>`
    ).join('');
    
    $('selPromo').innerHTML = cache.promociones.map(p => 
      `<option value="${p.id}">${p.anio}</option>`
    ).join('');

    applyFilter();
  }catch(err){
    toast('Error', err.message);
  }
}

// ============================================
// GESTI√ìN DE PROMOCIONES
// ============================================
async function cargarPromociones() {
  try {
    $('loadingPromocion').style.display = 'block';
    $('promocionesContainer').style.display = 'none';
    $('emptyState').style.display = 'none';

    // Usar apiFetch en lugar de fetch directo
    const promociones = await apiFetch('/promociones');
    cache.promociones = promociones;
    
    // Actualizar KPI
    $('kpiPromo').textContent = promociones.length;
    
    mostrarPromociones(promociones);

  } catch (error) {
    console.error('Error:', error);
    mostrarAlerta('Error al cargar las promociones: ' + error.message, 'danger');
    $('loadingPromocion').style.display = 'none';
    $('emptyState').style.display = 'block';
  }
}

function mostrarPromociones(promociones) {
  $('loadingPromocion').style.display = 'none';
  
  if (promociones.length === 0) {
    $('emptyState').style.display = 'block';
    $('promocionesContainer').style.display = 'none';
    return;
  }

  $('emptyState').style.display = 'none';
  $('promocionesContainer').style.display = 'block';

  const tbody = $('tablaPromociones').querySelector('tbody');
  tbody.innerHTML = promociones.map(p => `
    <tr>
      <td><strong>${p.anio}</strong></td>
      <td>${escapeHtml(p.descripcion) || '<span style="color: var(--muted)">Sin descripci√≥n</span>'}</td>
      <td style="text-align: center;">
        <span class="badge-count">${p.total_proyectos || 0} proyecto${(p.total_proyectos || 0) !== 1 ? 's' : ''}</span>
      </td>
      <td>${formatearFecha(p.created_at)}</td>
      <td>
        <div class="btn-group">
          <button class="btn small" onclick="editarPromocion(${p.id})" title="Editar">
            ‚úèÔ∏è Editar
          </button>
          <button class="btn small danger" onclick="mostrarModalEliminar(${p.id}, '${p.anio}')" title="Eliminar">
            üóëÔ∏è Eliminar
          </button>
        </div>
      </td>
    </tr>
  `).join('');
}

function mostrarModalCrear() {
  $('modalTitulo').textContent = '‚ûï Nueva Promoci√≥n';
  $('formPromocion').reset();
  $('promocionId').value = '';
  abrirModal('modalPromocion');
}

async function editarPromocion(id) {
  try {
    // Usar apiFetch
    const promocion = await apiFetch(`/promociones/${id}`);
    
    $('modalTitulo').textContent = '‚úèÔ∏è Editar Promoci√≥n';
    $('promocionId').value = promocion.id;
    $('anio').value = promocion.anio;
    $('descripcion').value = promocion.descripcion || '';
    
    abrirModal('modalPromocion');

  } catch (error) {
    console.error('Error:', error);
    mostrarAlerta('Error al cargar la promoci√≥n: ' + error.message, 'danger');
  }
}

async function guardarPromocion(event) {
  if(event) event.preventDefault();
  
  const id = $('promocionId').value;
  const anio = $('anio').value.trim();
  const descripcion = $('descripcion').value.trim();

  if (!anio) {
    mostrarAlerta('El a√±o es obligatorio', 'warning');
    return;
  }

  const anioNum = parseInt(anio);
  if (isNaN(anioNum) || anioNum < 2000 || anioNum > 2100) {
    mostrarAlerta('El a√±o debe estar entre 2000 y 2100', 'warning');
    return;
  }

  try {
    // Usar apiFetch
    const path = id ? `/promociones/${id}` : '/promociones';
    const method = id ? 'PUT' : 'POST';

    const data = await apiFetch(path, {
      method: method,
      body: { anio: anioNum, descripcion }
    });

    mostrarAlerta(data.msg, 'success');
    cerrarModal('modalPromocion');
    cargarPromociones();
    loadAll(); // Refrescar KPIs

  } catch (error) {
    console.error('Error:', error);
    mostrarAlerta(error.message, 'danger');
  }
}

function mostrarModalEliminar(id, anio) {
  $('idEliminar').value = id;
  $('promocionEliminar').textContent = anio;
  abrirModal('modalEliminar');
}

async function confirmarEliminar() {
  const id = $('idEliminar').value;

  try {
    // Usar apiFetch
    const data = await apiFetch(`/promociones/${id}`, {
      method: 'DELETE'
    });

    mostrarAlerta(data.msg, 'success');
    cerrarModal('modalEliminar');
    cargarPromociones();
    loadAll(); // Refrescar KPIs

  } catch (error) {
    console.error('Error:', error);
    mostrarAlerta(error.message, 'danger');
  }
}

// ============================================
// DESCARGAS
// ============================================
function descargarMemoriasPorFiltro(){
  const espId = $('selEsp').value;
  const promoId = $('selPromo').value;
  
  if(!espId || !promoId) {
    return toast('Error', 'Selecciona especialidad y promoci√≥n');
  }
  
  window.open(`/api/descargas/pdfs/${espId}/${promoId}`, '_blank');
}

function descargarExcelGeneral(){
  window.open('/api/descargas/excel', '_blank');
}

// ============================================
// UTILIDADES
// ============================================
function abrirModal(modalId) {
  $(modalId).classList.add('show');
}

function cerrarModal(modalId) {
  $(modalId).classList.remove('show');
}

function mostrarAlerta(mensaje, tipo) {
  const alertContainer = $('alertContainer');
  const alert = document.createElement('div');
  alert.className = `alert alert-${tipo}`;
  
  const iconos = {
    'success': '‚úÖ',
    'danger': '‚ùå',
    'warning': '‚ö†Ô∏è',
    'info': '‚ÑπÔ∏è'
  };
  
  alert.innerHTML = `
    <span>${iconos[tipo] || '‚ÑπÔ∏è'}</span>
    <span>${mensaje}</span>
  `;
  
  alertContainer.appendChild(alert);

  setTimeout(() => {
    alert.remove();
  }, 5000);
}

function formatearFecha(fecha) {
  if (!fecha) return 'N/A';
  const date = new Date(fecha);
  return date.toLocaleDateString('es-EC', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
}

function escapeHtml(str){
  return String(str || '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

// Cerrar modales al hacer clic fuera
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal')) {
    e.target.classList.remove('show');
  }
});

// ============================================
// INICIALIZACI√ìN
// ============================================
loadAll();
</script>
</body>
</html>