<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Panel Admin | Repositorio Acad√©mico</title>
  <link rel="stylesheet" href="assets/css/app.css">
</head>
<body>
<div class="container">
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-badge">RA</div>
      <div>
        <div class="brand-title">Administrador</div>
        <div class="brand-sub">Gesti√≥n institucional</div>
      </div>
    </div>

    <div class="nav">
      <button id="navHome" class="active" onclick="show('home')">Dashboard</button>
      <button id="navProyectos" onclick="show('proyectos')">Proyectos</button>
      <button id="navDescargas" onclick="show('descargas')">Descargas</button>
      <button class="danger btn" style="margin-top:8px;" onclick="logout()">Cerrar sesi√≥n</button>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="search">
        <span style="color:var(--muted)">üîé</span>
        <input id="q" placeholder="Buscar..." oninput="applyFilter()">
      </div>
      <div class="pill">üõ°Ô∏è Admin</div>
      <button class="btn success" onclick="descargarExcelGeneral()">
        üìä Descargar Excel General
      </button>
      <button class="btn warning" onclick="toggleTheme()">üåì Tema</button>
    </div>

    <section id="home">
      <div class="grid">
        <div class="card col-3">
          <h3>Promociones</h3>
          <div class="kpi" id="kpiPromo">‚Äî</div>
          <div class="hint">Registradas</div>
        </div>
        <div class="card col-3">
          <h3>Especialidades</h3>
          <div class="kpi" id="kpiEsp">‚Äî</div>
          <div class="hint">Activas</div>
        </div>
        <div class="card col-3">
          <h3>Proyectos</h3>
          <div class="kpi" id="kpiProy">‚Äî</div>
          <div class="hint">Totales</div>
        </div>
        <div class="card col-3">
          <h3>Memorias</h3>
          <div class="kpi" id="kpiMem">‚Äî</div>
          <div class="hint">Subidas</div>
        </div>

        <div class="card col-12">
          <h3>Resumen</h3>
          <div style="color:var(--muted); font-size:13px;">
            Desde este panel puedes ver todos los proyectos, descargar memorias t√©cnicas por especialidad/promoci√≥n, 
            y generar reportes Excel generales.
          </div>
        </div>
      </div>
    </section>

    <section id="proyectos" style="display:none;">
      <div class="card">
        <h3>Todos los Proyectos</h3>
        
        <div style="margin-bottom:16px; display:flex; gap:12px; flex-wrap:wrap;">
          <select class="input" id="filtroPromocion" onchange="applyFilter()" style="width:auto;">
            <option value="">Todas las promociones</option>
          </select>
          <select class="input" id="filtroEspecialidad" onchange="applyFilter()" style="width:auto;">
            <option value="">Todas las especialidades</option>
          </select>
        </div>

        <table class="table" id="tblProy">
          <thead>
            <tr>
              <th>Promoci√≥n</th>
              <th>Especialidad</th>
              <th>Tema/Proyecto</th>
              <th>Tutor</th>
              <th>Estado</th>
              <th>Memoria</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="descargas" style="display:none;">
      <div class="card">
        <h3>Descargar Memorias T√©cnicas</h3>
        <p style="color:var(--muted); font-size:13px;">
          Selecciona una especialidad y promoci√≥n para descargar todas las memorias t√©cnicas en un archivo ZIP.
        </p>

        <div class="grid">
          <div class="card col-6">
            <label>Especialidad</label>
            <select class="input" id="selEsp"></select>
          </div>
          <div class="card col-6">
            <label>Promoci√≥n</label>
            <select class="input" id="selPromo"></select>
          </div>
        </div>

        <button class="btn success" onclick="descargarMemoriasPorFiltro()">
          üì• Descargar ZIP
        </button>
      </div>

      <div class="card" style="margin-top:20px;">
        <h3>Descarga General</h3>
        <p style="color:var(--muted); font-size:13px;">
          Descarga un Excel con informaci√≥n completa de todos los proyectos del sistema.
        </p>
        <button class="btn success" onclick="descargarExcelGeneral()">
          üìä Descargar Excel General
        </button>
      </div>
    </section>

  </main>
</div>

<div class="toast" id="toastBox">
  <strong id="toastTitle">Aviso</strong>
  <p id="toastMsg"></p>
</div>

<script src="assets/js/api.js"></script>
<script src="assets/js/ui.js"></script>
<script>initTheme();</script>

<script>
requireAuth('admin');

let cache = { proyectos:[], especialidades:[], promociones:[] };

function setActive(btnId){
  ['navHome','navProyectos','navDescargas'].forEach(id=>$(id).classList.remove('active'));
  $(btnId).classList.add('active');
}

function show(section){
  ['home','proyectos','descargas'].forEach(s=>$(s).style.display='none');
  $(section).style.display='block';
  setActive('nav' + section.charAt(0).toUpperCase() + section.slice(1).replace('home','Home'));
  applyFilter();
}

function applyFilter(){
  const q = $('q').value.trim().toLowerCase();
  const promoFiltro = $('filtroPromocion')?.value || '';
  const espFiltro = $('filtroEspecialidad')?.value || '';
  
  const p = cache.proyectos.filter(x => {
    const matchText = `${x.tema_proyecto} ${x.tutor} ${x.especialidad} ${x.promocion} ${x.estado}`.toLowerCase().includes(q);
    const matchPromo = !promoFiltro || String(x.promocion) === promoFiltro;
    const matchEsp = !espFiltro || x.especialidad === espFiltro;
    return matchText && matchPromo && matchEsp;
  });
  
  $('tblProy').querySelector('tbody').innerHTML = p.map(x=>`
    <tr>
      <td>${x.promocion}</td>
      <td>${x.especialidad}</td>
      <td><strong>${escapeHtml(x.tema_proyecto)}</strong></td>
      <td>${escapeHtml(x.tutor)}</td>
      <td>${statusBadge(x.estado)}</td>
      <td>${x.nombre_archivo ? 
        `<a class="badge" href="/uploads/${encodeURIComponent(x.nombre_archivo)}" target="_blank">Ver PDF</a>` : 
        '<span class="badge warn">Sin archivo</span>'
      }</td>
    </tr>
  `).join('');
}

async function loadAll(){
  try{
    cache.proyectos = await apiFetch('/proyectos');
    cache.especialidades = await apiFetch('/tutores/especialidades');
    cache.promociones = await apiFetch('/tutores/promociones');

    $('kpiProy').textContent = cache.proyectos.length;
    $('kpiMem').textContent = cache.proyectos.filter(x => x.nombre_archivo).length;
    $('kpiEsp').textContent = cache.especialidades.length;
    $('kpiPromo').textContent = cache.promociones.length;

    // Llenar filtros
    $('filtroPromocion').innerHTML = '<option value="">Todas las promociones</option>' +
      cache.promociones.map(p => `<option value="${p.anio}">${p.anio}</option>`).join('');
    
    $('filtroEspecialidad').innerHTML = '<option value="">Todas las especialidades</option>' +
      cache.especialidades.map(e => `<option value="${escapeHtml(e.nombre)}">${escapeHtml(e.nombre)}</option>`).join('');

    // Llenar selectores de descarga
    $('selEsp').innerHTML = cache.especialidades.map(e => 
      `<option value="${e.id}">${escapeHtml(e.nombre)}</option>`
    ).join('');
    
    $('selPromo').innerHTML = cache.promociones.map(p => 
      `<option value="${p.id}">${p.anio}</option>`
    ).join('');

    applyFilter();
  }catch(err){
    toast('Error', err.message);
  }
}

function descargarMemoriasPorFiltro(){
  const espId = $('selEsp').value;
  const promoId = $('selPromo').value;
  
  if(!espId || !promoId) {
    return toast('Error', 'Selecciona especialidad y promoci√≥n');
  }
  
  window.open(`/api/descargas/pdfs/${espId}/${promoId}`, '_blank');
}

function descargarExcelGeneral(){
  window.open('/api/descargas/excel', '_blank');
}

function escapeHtml(str){
  return String(str || '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

loadAll();
</script>
</body>
</html>