<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Panel Estudiante | Repositorio AcadÃ©mico</title>
  <link rel="stylesheet" href="assets/css/app.css">
</head>
<body>

<div class="container">
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-badge">RA</div>
      <div>
        <div class="brand-title">Estudiante</div>
        <div class="brand-sub">Proyecto Final</div>
      </div>
    </div>

    <div class="nav">
      <button id="navHome" class="active" onclick="show('home')">Dashboard</button>
      <button id="navUp" onclick="show('subir')">Subir / Reemplazar</button>
      <button class="danger btn" style="margin-top:8px;" onclick="logout()">Cerrar sesiÃ³n</button>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="pill">ðŸŽ“ Estudiante</div>
      <button class="btn warning" onclick="toggleTheme()">ðŸŒ“ Tema</button>
    </div>

    <!-- DASHBOARD -->
    <section id="home">
      <div class="grid">
        <div class="card col-6">
          <h3>Mi proyecto</h3>
          <div id="proyectoBox" style="color:var(--muted); font-size:13px;"></div>
        </div>

        <div class="card col-6">
          <h3>Archivo final</h3>
          <div id="archivoBox"></div>
        </div>
      </div>
    </section>

    <!-- SUBIR -->
    <section id="subir" style="display:none;">
      <div class="card">
        <h3>Subir / Reemplazar archivo final</h3>

        <div class="form">
          <div class="span-12">
            <input class="input" id="nombre_visible"
                   placeholder="Nombre visible del archivo (opcional)">
          </div>

          <div class="span-12">
            <input class="input" type="file" id="archivo">
          </div>
        </div>

        <div style="height:12px"></div>
        <button class="btn success" onclick="subir()">Subir archivo</button>
      </div>
    </section>
  </main>
</div>

<div class="toast" id="toastBox">
  <strong id="toastTitle">Aviso</strong>
  <p id="toastMsg"></p>
</div>

<script src="assets/js/api.js"></script>
<script src="assets/js/ui.js"></script>
<script>initTheme();</script>

<script>
requireAuth('estudiante');

let proyecto = null;
let archivoFinal = null;

function setActive(btnId){
  ['navHome','navUp'].forEach(id=>$(id).classList.remove('active'));
  $(btnId).classList.add('active');
}
function show(section){
  ['home','subir'].forEach(s=>$(s).style.display='none');
  $(section).style.display='block';
  setActive(section==='home'?'navHome':'navUp');
}

async function loadAll(){
  try{
    const proyectos = await apiFetch('/proyectos');
    proyecto = proyectos[0] || null;

    if(!proyecto){
      $('proyectoBox').innerHTML =
        `<span class="badge warn">No tienes proyecto asignado</span>`;
      $('archivoBox').innerHTML = '';
      return;
    }

    $('proyectoBox').innerHTML = `
      <div class="badge">${proyecto.titulo}</div>
      <div style="height:6px"></div>
      ${statusBadge(proyecto.estado)}
    `;

    const archivos = await apiFetch('/archivo-final');
    archivoFinal = archivos.find(a => a.proyecto_id === proyecto.id) || null;

    renderArchivo();

  }catch(err){
    toast('Error', err.message);
  }
}

function renderArchivo(){
  if(!archivoFinal){
    $('archivoBox').innerHTML = `
      <span class="badge warn">No has subido el archivo final</span>
    `;
    return;
  }

  $('archivoBox').innerHTML = `
    <div class="badge">${archivoFinal.nombre_visible || 'Archivo final'}</div>
    <div style="height:6px"></div>

    <a class="badge" target="_blank"
       href="http://localhost:3000/uploads/${archivoFinal.nombre_archivo}">
       Ver archivo
    </a>

    <div style="height:10px"></div>

    <div class="form">
      <div class="span-12">
        <input class="input" id="nuevoNombre"
               placeholder="Nuevo nombre visible">
      </div>
    </div>

    <div style="height:8px"></div>

    <button class="btn" onclick="renombrar()">Renombrar</button>
    <button class="btn danger" onclick="eliminar()">Eliminar</button>
  `;
}

async function subir(){
  try{
    if(!proyecto) return toast('Error', 'No tienes proyecto');

    const file = $('archivo').files[0];
    if(!file) return toast('Falta archivo', 'Selecciona un archivo');

    const form = new FormData();
    form.append('archivo', file);
    form.append('proyecto_id', proyecto.id);
    form.append('nombre_visible', $('nombre_visible').value.trim());

    const res = await fetch('http://localhost:3000/api/archivo-final', {
      method: 'POST',
      headers: { 'Authorization': getToken() },
      body: form
    });

    if(!res.ok){
      const t = await res.text();
      throw new Error(t);
    }

    toast('Listo âœ…', 'Archivo guardado');
    $('archivo').value = '';
    $('nombre_visible').value = '';
    await loadAll();
    show('home');

  }catch(err){
    toast('Error', err.message);
  }
}

async function renombrar(){
  try{
    const nombre = $('nuevoNombre').value.trim();
    if(!nombre) return toast('Falta nombre', 'Escribe un nombre');

    await apiFetch(`/archivo-final/${proyecto.id}/nombre`, {
      method:'PATCH',
      body:{ nombre_visible: nombre }
    });

    toast('Actualizado', 'Nombre cambiado');
    await loadAll();

  }catch(err){
    toast('Error', err.message);
  }
}

async function eliminar(){
  if(!confirm('Â¿Eliminar archivo final?')) return;

  try{
    await apiFetch(`/archivo-final/${proyecto.id}`, { method:'DELETE' });
    toast('Eliminado', 'Archivo eliminado');
    await loadAll();
  }catch(err){
    toast('Error', err.message);
  }
}

loadAll();
</script>

</body>
</html>
