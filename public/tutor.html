<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Panel Tutor | Repositorio Acad√©mico</title>
  <link rel="stylesheet" href="assets/css/app.css">
</head>
<body>
<div class="container">
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-badge">RA</div>
      <div>
        <div class="brand-title">Tutor</div>
        <div class="brand-sub">Gesti√≥n de Memorias T√©cnicas</div>
      </div>
    </div>

    <div class="nav">
      <button id="navHome" class="active" onclick="show('home')">Dashboard</button>
      <button id="navProyectos" onclick="show('proyectos')">Proyectos</button>
      <button id="navCrear" onclick="show('crear')">Crear Proyecto</button>
      <button class="danger btn" style="margin-top:8px;" onclick="logout()">Cerrar sesi√≥n</button>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="search">
        <span style="color:var(--muted)">üîé</span>
        <input id="q" placeholder="Buscar tema/proyecto..." oninput="renderTabla()">
      </div>
      <button class="btn warning" onclick="toggleTheme()">üåì Tema</button>
    </div>

    <!-- DASHBOARD -->
    <section id="home">
      <div class="grid">

        <div class="card col-4">
          <h3>Proyectos</h3>
          <div class="kpi" id="kpiProy">‚Äî</div>
          <div class="hint">En el sistema</div>
        </div>

        <div class="card col-4">
          <h3>Memorias T√©cnicas</h3>
          <div class="kpi" id="kpiFiles">‚Äî</div>
          <div class="hint">PDFs subidos</div>
        </div>

        <div class="card col-12">
          <h3>Acceso r√°pido</h3>
          <div style="color:var(--muted); font-size:13px;">
            Ve a <b>"Proyectos"</b>, selecciona promoci√≥n y especialidad para gestionar las memorias t√©cnicas.
          </div>
          <div style="height:10px"></div>
          <button class="btn" onclick="show('proyectos')">Ver Proyectos</button>
        </div>
      </div>
    </section>

    <!-- PROYECTOS -->
    <section id="proyectos" style="display:none;">
      <div class="grid">
        <div class="card col-4">
          <h3>Filtros</h3>

          <label style="font-size:13px; color:var(--muted);">Promoci√≥n</label>
          <select class="input" id="promocionSel" onchange="cargarProyectos()">
            <option value="">Seleccionar...</option>
          </select>

          <label style="font-size:13px; color:var(--muted); margin-top:12px;">Especialidad</label>
          <select class="input" id="especialidadSel" onchange="cargarProyectos()">
            <option value="">Seleccionar...</option>
          </select>

          <div style="height:10px"></div>
          <div id="filtrosInfo" style="color:var(--muted); font-size:13px;"></div>

          <div style="height:12px"></div>
          <button class="btn" onclick="cargarProyectos()">Actualizar</button>
          <button class="btn success" onclick="descargarMemoriasTecnicas()" id="btnDescargar" disabled>
            üì• Descargar Memorias (ZIP)
          </button>
        </div>

        <div class="card col-8">
          <h3>Proyectos / Memorias T√©cnicas</h3>
          <div style="color:var(--muted); font-size:13px;">
            Selecciona una promoci√≥n y especialidad para ver los proyectos.
          </div>

          <div style="height:10px"></div>

          <div style="overflow:auto;">
            <table class="table" id="tblProy">
              <thead>
                <tr>
                  <th>Tema/Proyecto</th>
                  <th>Estado</th>
                  <th>Memoria T√©cnica</th>
                  <!-- ‚ùå ELIMINADO: Calificar -->
                  <!-- ‚úÖ NUEVO -->
                  <th style="min-width:180px;">Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div style="height:10px"></div>
          <div id="hint" style="color:var(--muted); font-size:12px;"></div>
        </div>
      </div>
    </section>

    <!-- CREAR PROYECTO -->
    <section id="crear" style="display:none;">
      <div class="card">
        <h3>Crear Nuevo Proyecto</h3>
        <div style="color:var(--muted); font-size:13px; margin-bottom:20px;">
          Un proyecto representa un tema de memoria t√©cnica para una promoci√≥n y especialidad espec√≠fica.
        </div>

        <label>Promoci√≥n</label>
        <select class="input" id="promocionNuevo">
          <option value="">Seleccionar...</option>
        </select>

        <label>Especialidad</label>
        <select class="input" id="especialidadNuevo">
          <option value="">Seleccionar...</option>
        </select>

        <label>T√≠tulo del Proyecto (Tema)</label>
        <input class="input" id="tituloNuevo" placeholder="Ej: Sistema de Gesti√≥n Acad√©mica">

        <label>Descripci√≥n (opcional)</label>
        <textarea class="input" id="descripcionNuevo" rows="3"
                  placeholder="Breve descripci√≥n del proyecto..."></textarea>

        <label>Memoria T√©cnica (PDF) - Opcional</label>
        <div style="color:var(--muted); font-size:12px; margin-bottom:8px;">
          Puedes subir la memoria t√©cnica ahora o despu√©s desde "Proyectos"
        </div>
        <input type="file" class="input" id="archivoNuevo" accept=".pdf" onchange="mostrarInfoArchivo()">
        <div id="archivoInfo" style="color:var(--muted); font-size:12px; margin-top:4px;"></div>

        <div style="height:10px"></div>
        <button class="btn success" onclick="crearProyecto()" id="btnCrearProyecto">
          Crear Proyecto
        </button>
        <button class="btn" onclick="limpiarFormulario()">Limpiar</button>
      </div>
    </section>

  </main>
</div>

<div class="toast" id="toastBox">
  <strong id="toastTitle">Aviso</strong>
  <p id="toastMsg"></p>
</div>

<!-- Modal para subir archivo -->
<div id="modalUpload" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0;
     background:rgba(0,0,0,0.7); z-index:1000; padding:40px;">
  <div class="card" style="max-width:500px; margin:auto;">
    <h3>Subir Memoria T√©cnica (PDF)</h3>
    <p style="color:var(--muted); font-size:13px;">
      Proyecto: <strong id="modalProyectoNombre"></strong>
    </p>
    <input type="file" id="fileUpload" accept=".pdf" class="input">
    <div style="height:10px"></div>
    <button class="btn success" onclick="subirArchivo()">Subir</button>
    <button class="btn" onclick="cerrarModal()">Cancelar</button>
  </div>
</div>

<!-- ‚úÖ NUEVO: Modal editar proyecto -->
<div id="modalEditar" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0;
     background:rgba(0,0,0,0.7); z-index:1001; padding:40px;">
  <div class="card" style="max-width:560px; margin:auto;">
    <h3>Editar Proyecto</h3>
    <p style="color:var(--muted); font-size:13px;">
      Proyecto: <strong id="editProyectoNombre"></strong>
    </p>

    <input type="hidden" id="editProyectoId">

    <label>T√≠tulo</label>
    <input class="input" id="editTitulo">

    <label>Descripci√≥n</label>
    <textarea class="input" id="editDescripcion" rows="3"></textarea>

    <label>Estado</label>
    <select class="input" id="editEstado">
      <option value="pendiente">Pendiente</option>
      <option value="aprobado">Aprobado</option>
      <option value="rechazado">Rechazado</option>
    </select>

    <div style="height:10px"></div>

    <label>Memoria T√©cnica (PDF)</label>
    <div style="color:var(--muted); font-size:12px; margin-bottom:8px;">
      Puedes subir/reemplazar el PDF o eliminar el actual.
    </div>
    <input type="file" class="input" id="editArchivo" accept=".pdf" onchange="mostrarInfoArchivoEdicion()">
    <div id="editArchivoInfo" style="color:var(--muted); font-size:12px; margin-top:6px;"></div>

    <div style="height:12px"></div>

    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button class="btn success" onclick="guardarEdicionProyecto()">Guardar cambios</button>
      <button class="btn danger" onclick="eliminarArchivoProyecto()">Eliminar PDF</button>
      <button class="btn danger" onclick="eliminarProyectoDesdeModal()">Eliminar Proyecto</button>
      <button class="btn" onclick="cerrarModalEditar()">Cerrar</button>
    </div>
  </div>
</div>

<script src="assets/js/api.js"></script>
<script src="assets/js/ui.js"></script>
<script>initTheme();</script>
<script>
requireAuth('tutor');

let cache = {
  promociones: [],
  especialidades: [],
  proyectos: [],
  promocionActual: null,
  especialidadActual: null,
  proyectoIdUpload: null
};

function setActive(btnId){
  ['navHome','navProyectos','navCrear'].forEach(id=>$(id).classList.remove('active'));
  $(btnId).classList.add('active');
}

function show(section){
  ['home','proyectos','crear'].forEach(s=>$(s).style.display='none');
  $(section).style.display='block';
  setActive('nav' + section.charAt(0).toUpperCase() + section.slice(1).replace('home','Home'));
}

async function loadInicial(){
  try{
    // Cargar promociones
    cache.promociones = await apiFetch('/tutores/promociones');

    // Cargar especialidades
    cache.especialidades = await apiFetch('/tutores/especialidades');

    // Cargar estad√≠sticas
    const stats = await apiFetch('/tutores/estadisticas');

    const elProy   = $('kpiProy');
    const elFiles  = $('kpiFiles');

    if (elProy)   elProy.textContent   = stats.total_proyectos;
    if (elFiles)  elFiles.textContent  = stats.proyectos_con_archivo;

    // Llenar selectores
    llenarSelectores();

  }catch(err){
    toast('Error', err.message);
  }
}

function llenarSelectores(){
  // Selector de filtros (proyectos)
  const htmlPromos = cache.promociones.map(p => `
    <option value="${p.id}">${p.anio}</option>
  `).join('');

  const htmlEsps = cache.especialidades.map(e => `
    <option value="${e.id}">${escapeHtml(e.nombre)}</option>
  `).join('');

  $('promocionSel').innerHTML = '<option value="">Seleccionar...</option>' + htmlPromos;
  $('especialidadSel').innerHTML = '<option value="">Seleccionar...</option>' + htmlEsps;

  // Selector de crear proyecto
  $('promocionNuevo').innerHTML = '<option value="">Seleccionar...</option>' + htmlPromos;
  $('especialidadNuevo').innerHTML = '<option value="">Seleccionar...</option>' + htmlEsps;
}

async function cargarProyectos(){
  try{
    const promocionId = $('promocionSel').value;
    const especialidadId = $('especialidadSel').value;

    if (!promocionId || !especialidadId) {
      $('filtrosInfo').innerHTML = '<span class="badge warn">Selecciona promoci√≥n y especialidad</span>';
      $('tblProy').querySelector('tbody').innerHTML = '';
      $('hint').textContent = 'Selecciona filtros para ver proyectos';
      $('btnDescargar').disabled = true;
      return;
    }

    cache.promocionActual = cache.promociones.find(p => String(p.id) === promocionId);
    cache.especialidadActual = cache.especialidades.find(e => String(e.id) === especialidadId);

    $('filtrosInfo').innerHTML = `
      <div class="badge">${cache.promocionActual.anio}</div>
      <div style="height:4px"></div>
      <div class="badge info">${escapeHtml(cache.especialidadActual.nombre)}</div>
    `;

    // Cargar proyectos
    cache.proyectos = await apiFetch(`/tutores/proyectos/${promocionId}/${especialidadId}`);

    renderTabla();
    show('proyectos');
    $('btnDescargar').disabled = false;

  }catch(err){
    toast('Error', err.message);
  }
}

function renderTabla(){
  const q = $('q').value.trim().toLowerCase();

  const rows = cache.proyectos.filter(x => {
    const s = `${x.tema_proyecto||''} ${x.descripcion||''} ${x.estado||''}`.toLowerCase();
    return s.includes(q);
  });

  const tbody = $('tblProy').querySelector('tbody');
  tbody.innerHTML = rows.map(x => {
    const hasFile = !!x.nombre_archivo;

    const archivoCell = hasFile
      ? `<div>
           <div class="badge">${escapeHtml(x.nombre_visible || 'Memoria T√©cnica')}</div>
           <div style="height:6px"></div>
           <a class="badge" target="_blank"
              href="/uploads/${encodeURIComponent(x.nombre_archivo)}">
              Ver PDF
           </a>
         </div>`
      : `<button class="btn success" onclick="abrirModalUpload(${x.proyecto_id}, '${escapeHtml(x.tema_proyecto)}')">
           Subir PDF
         </button>`;

    return `
      <tr>
        <td><strong>${escapeHtml(x.tema_proyecto)}</strong></td>
        <td>${statusBadge(x.estado)}</td>
        <td>${archivoCell}</td>

        <td>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn warning" onclick="abrirModalEditar(${x.proyecto_id})">Editar</button>
            <button class="btn danger" onclick="eliminarProyecto(${x.proyecto_id})">Eliminar</button>
          </div>
        </td>
      </tr>
    `;
  }).join('');

  $('hint').textContent = rows.length
    ? `Mostrando ${rows.length} proyecto(s).`
    : 'No hay proyectos con esos filtros.';
}

function abrirModalUpload(proyectoId, nombreProyecto){
  cache.proyectoIdUpload = proyectoId;
  $('modalProyectoNombre').textContent = nombreProyecto;
  $('modalUpload').style.display = 'block';
}

function cerrarModal(){
  $('modalUpload').style.display = 'none';
  cache.proyectoIdUpload = null;
  $('fileUpload').value = '';
}

async function subirArchivo(){
  try{
    const file = $('fileUpload').files[0];
    if(!file) return toast('Error', 'Selecciona un archivo PDF');

    const formData = new FormData();
    formData.append('archivo', file);
    formData.append('proyecto_id', cache.proyectoIdUpload);

    const resp = await fetch(`${API_BASE}/archivo-final`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${getToken()}` },
      body: formData
    });

    if(!resp.ok) throw new Error('Error al subir archivo');

    toast('√âxito ‚úÖ', 'Memoria t√©cnica subida correctamente');
    cerrarModal();
    await cargarProyectos();

  }catch(err){
    toast('Error', err.message);
  }
}

/* =========================
   ‚úÖ NUEVO: EDITAR / ELIMINAR
========================= */

function abrirModalEditar(proyectoId){
  const p = cache.proyectos.find(x => String(x.proyecto_id) === String(proyectoId));
  if(!p) return toast('Error', 'No se encontr√≥ el proyecto');

  $('editProyectoId').value = p.proyecto_id;
  $('editProyectoNombre').textContent = p.tema_proyecto || '';
  $('editTitulo').value = p.tema_proyecto || '';
  $('editDescripcion').value = p.descripcion || '';
  $('editEstado').value = (p.estado || 'pendiente');

  $('editArchivo').value = '';
  $('editArchivoInfo').innerHTML = p.nombre_archivo
    ? `<span class="badge">PDF actual: ${escapeHtml(p.nombre_visible || 'Memoria T√©cnica')}</span>`
    : `<span class="badge warn">Sin PDF actualmente</span>`;

  $('modalEditar').style.display = 'block';
}

function cerrarModalEditar(){
  $('modalEditar').style.display = 'none';
}

function mostrarInfoArchivoEdicion(){
  const archivo = $('editArchivo').files[0];
  const info = $('editArchivoInfo');

  if(archivo) {
    const sizeMB = (archivo.size / 1024 / 1024).toFixed(2);
    info.innerHTML = `
      <span class="badge success">
        üìÑ ${escapeHtml(archivo.name)} (${sizeMB} MB) listo para subir
      </span>
    `;
  }
}

async function guardarEdicionProyecto(){
  try{
    const id = $('editProyectoId').value;
    const titulo = $('editTitulo').value.trim();
    const descripcion = $('editDescripcion').value.trim();
    const estado = $('editEstado').value;

    if(!titulo) return toast('Error', 'El t√≠tulo no puede estar vac√≠o');

    // 1) Actualizar datos
    await apiFetch(`/proyectos/${id}`, {
      method: 'PUT',
      body: { titulo, descripcion, estado }
    });

    // 2) Si seleccion√≥ archivo, subir/reemplazar
    const archivo = $('editArchivo').files[0];
    if(archivo){
      const formData = new FormData();
      formData.append('archivo', archivo);
      formData.append('proyecto_id', id);

      const resp = await fetch(`${API_BASE}/archivo-final`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${getToken()}` },
        body: formData
      });

      if(!resp.ok) {
        toast('Advertencia ‚ö†Ô∏è', 'Se guard√≥ el proyecto pero fall√≥ el PDF. Intenta de nuevo.');
      }
    }

    toast('√âxito ‚úÖ', 'Proyecto actualizado');
    cerrarModalEditar();
    await cargarProyectos();

  }catch(err){
    toast('Error', err.message);
  }
}

async function eliminarArchivoProyecto(){
  try{
    const id = $('editProyectoId').value;
    if(!confirm('¬øEliminar el PDF de este proyecto?')) return;

    await apiFetch(`/archivo-final/${id}`, { method: 'DELETE' });

    toast('√âxito ‚úÖ', 'PDF eliminado');
    await cargarProyectos();
    abrirModalEditar(id);

  }catch(err){
    toast('Error', err.message);
  }
}

async function eliminarProyectoDesdeModal(){
  const id = $('editProyectoId').value;
  await eliminarProyecto(id, true);
}

async function eliminarProyecto(proyectoId, desdeModal=false){
  try{
    if(!confirm('¬øEliminar este proyecto? (Se quitar√° del sistema)')) return;

    await apiFetch(`/proyectos/${proyectoId}`, { method: 'DELETE' });

    toast('√âxito ‚úÖ', 'Proyecto eliminado');
    if(desdeModal) cerrarModalEditar();
    await cargarProyectos();

  }catch(err){
    toast('Error', err.message);
  }
}

/* =========================
   CREAR PROYECTO (ORIGINAL)
========================= */

async function crearProyecto(){
  try{
    const promocion_id = $('promocionNuevo').value;
    const especialidad_id = $('especialidadNuevo').value;
    const titulo = $('tituloNuevo').value.trim();
    const descripcion = $('descripcionNuevo').value.trim();
    const archivo = $('archivoNuevo').files[0];

    if(!promocion_id || !especialidad_id || !titulo) {
      return toast('Error', 'Completa los campos requeridos (promoci√≥n, especialidad y t√≠tulo)');
    }

    // Deshabilitar bot√≥n mientras se procesa
    const btn = $('btnCrearProyecto');
    btn.disabled = true;
    btn.textContent = 'Creando...';

    // 1. Crear el proyecto
    const proyecto = await apiFetch('/proyectos', {
      method: 'POST',
      body: { promocion_id, especialidad_id, titulo, descripcion }
    });

    // 2. Si hay archivo, subirlo
    if(archivo) {
      btn.textContent = 'Subiendo archivo...';

      const formData = new FormData();
      formData.append('archivo', archivo);
      formData.append('proyecto_id', proyecto.id);

      const resp = await fetch(`${API_BASE}/archivo-final`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${getToken()}` },
        body: formData
      });

      if(!resp.ok) {
        toast('Advertencia ‚ö†Ô∏è', 'Proyecto creado pero fall√≥ subir el archivo. S√∫belo desde "Proyectos"');
      } else {
        toast('√âxito ‚úÖ', 'Proyecto creado y archivo subido correctamente');
      }
    } else {
      toast('√âxito ‚úÖ', 'Proyecto creado correctamente');
    }

    // Limpiar formulario y recargar
    limpiarFormulario();
    await loadInicial();
    show('proyectos');

  }catch(err){
    toast('Error', err.message);
  }finally{
    const btn = $('btnCrearProyecto');
    btn.disabled = false;
    btn.textContent = 'Crear Proyecto';
  }
}

function limpiarFormulario(){
  $('promocionNuevo').value = '';
  $('especialidadNuevo').value = '';
  $('tituloNuevo').value = '';
  $('descripcionNuevo').value = '';
  $('archivoNuevo').value = '';
  $('archivoInfo').textContent = '';
}

function mostrarInfoArchivo(){
  const archivo = $('archivoNuevo').files[0];
  const info = $('archivoInfo');

  if(archivo) {
    const sizeMB = (archivo.size / 1024 / 1024).toFixed(2);
    info.innerHTML = `
      <span class="badge success">
        üìÑ ${escapeHtml(archivo.name)} (${sizeMB} MB)
      </span>
    `;
  } else {
    info.textContent = '';
  }
}

async function descargarMemoriasTecnicas(){
  try {
    if(!cache.promocionActual || !cache.especialidadActual) {
      return toast('Error', 'Selecciona promoci√≥n y especialidad primero');
    }

    const btn = $('btnDescargar');
    btn.disabled = true;
    btn.textContent = '‚è≥ Descargando...';

    const token = getToken();
    const url = `/api/descargas/pdfs/${cache.especialidadActual.id}/${cache.promocionActual.id}`;

    const response = await fetch(url, {
      method: 'GET',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.msg || 'Error al descargar');
    }

    const blob = await response.blob();

    const contentDisposition = response.headers.get('Content-Disposition');
    let filename = 'Memorias_Tecnicas.zip';
    if (contentDisposition) {
      const match = contentDisposition.match(/filename="(.+)"/);
      if (match) filename = match[1];
    }

    const urlBlob = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = urlBlob;
    a.download = filename;
    document.body.appendChild(a);
    a.click();

    window.URL.revokeObjectURL(urlBlob);
    document.body.removeChild(a);

    toast('√âxito ‚úÖ', 'Memorias t√©cnicas descargadas correctamente');

  } catch (err) {
    console.error('Error al descargar:', err);
    toast('Error', err.message || 'No se pudo descargar el archivo');
  } finally {
    const btn = $('btnDescargar');
    btn.disabled = false;
    btn.textContent = 'üì• Descargar Memorias (ZIP)';
  }
}

function escapeHtml(str){
  return String(str || '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

loadInicial();
</script>
</body>
</html>
