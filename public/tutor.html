<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Panel Tutor | Repositorio AcadÃ©mico</title>
  <link rel="stylesheet" href="assets/css/app.css">
</head>
<body>
<div class="container">
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-badge">RA</div>
      <div>
        <div class="brand-title">Tutor</div>
        <div class="brand-sub">GestiÃ³n de Memorias TÃ©cnicas</div>
      </div>
    </div>

    <div class="nav">
      <button id="navHome" class="active" onclick="show('home')">Dashboard</button>
      <button id="navProyectos" onclick="show('proyectos')">Proyectos</button>
      <button id="navCrear" onclick="show('crear')">Crear Proyecto</button>
      <button class="danger btn" style="margin-top:8px;" onclick="logout()">Cerrar sesiÃ³n</button>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="search">
        <span style="color:var(--muted)">ðŸ”Ž</span>
        <input id="q" placeholder="Buscar tema/proyecto..." oninput="renderTabla()">
      </div>
      <div class="pill">ðŸ“š Tutor</div>
      <button class="btn warning" onclick="toggleTheme()">ðŸŒ“ Tema</button>
    </div>

    <!-- DASHBOARD -->
    <section id="home">
      <div class="grid">
        <div class="card col-4">
          <h3>Promociones</h3>
          <div class="kpi" id="kpiPromos">â€”</div>
          <div class="hint">Totales</div>
        </div>

        <div class="card col-4">
          <h3>Proyectos</h3>
          <div class="kpi" id="kpiProy">â€”</div>
          <div class="hint">En el sistema</div>
        </div>

        <div class="card col-4">
          <h3>Memorias TÃ©cnicas</h3>
          <div class="kpi" id="kpiFiles">â€”</div>
          <div class="hint">PDFs subidos</div>
        </div>

        <div class="card col-12">
          <h3>Acceso rÃ¡pido</h3>
          <div style="color:var(--muted); font-size:13px;">
            Ve a <b>"Proyectos"</b>, selecciona promociÃ³n y especialidad para gestionar las memorias tÃ©cnicas.
          </div>
          <div style="height:10px"></div>
          <button class="btn" onclick="show('proyectos')">Ver Proyectos</button>
        </div>
      </div>
    </section>

    <!-- PROYECTOS -->
    <section id="proyectos" style="display:none;">
      <div class="grid">
        <div class="card col-4">
          <h3>Filtros</h3>

          <label style="font-size:13px; color:var(--muted);">PromociÃ³n</label>
          <select class="input" id="promocionSel" onchange="cargarProyectos()">
            <option value="">Seleccionar...</option>
          </select>

          <label style="font-size:13px; color:var(--muted); margin-top:12px;">Especialidad</label>
          <select class="input" id="especialidadSel" onchange="cargarProyectos()">
            <option value="">Seleccionar...</option>
          </select>

          <div style="height:10px"></div>
          <div id="filtrosInfo" style="color:var(--muted); font-size:13px;"></div>

          <div style="height:12px"></div>
          <button class="btn" onclick="cargarProyectos()">Actualizar</button>
          <button class="btn success" onclick="descargarMemoriasTecnicas()" id="btnDescargar" disabled>
            ðŸ“¥ Descargar Memorias (ZIP)
          </button>
        </div>

        <div class="card col-8">
          <h3>Proyectos / Memorias TÃ©cnicas</h3>
          <div style="color:var(--muted); font-size:13px;">
            Selecciona una promociÃ³n y especialidad para ver los proyectos.
          </div>

          <div style="height:10px"></div>

          <div style="overflow:auto;">
            <table class="table" id="tblProy">
              <thead>
                <tr>
                  <th>Tema/Proyecto</th>
                  <th>Estado</th>
                  <th>Memoria TÃ©cnica</th>
                  <th style="min-width:240px;">Calificar</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div style="height:10px"></div>
          <div id="hint" style="color:var(--muted); font-size:12px;"></div>
        </div>
      </div>
    </section>

    <!-- CREAR PROYECTO -->
    <section id="crear" style="display:none;">
      <div class="card">
        <h3>Crear Nuevo Proyecto</h3>
        <div style="color:var(--muted); font-size:13px; margin-bottom:20px;">
          Un proyecto representa un tema de memoria tÃ©cnica para una promociÃ³n y especialidad especÃ­fica.
        </div>

        <label>PromociÃ³n</label>
        <select class="input" id="promocionNuevo">
          <option value="">Seleccionar...</option>
        </select>

        <label>Especialidad</label>
        <select class="input" id="especialidadNuevo">
          <option value="">Seleccionar...</option>
        </select>

        <label>TÃ­tulo del Proyecto (Tema)</label>
        <input class="input" id="tituloNuevo" placeholder="Ej: Sistema de GestiÃ³n AcadÃ©mica">

        <label>DescripciÃ³n (opcional)</label>
        <textarea class="input" id="descripcionNuevo" rows="3" 
                  placeholder="Breve descripciÃ³n del proyecto..."></textarea>

        <div style="height:10px"></div>
        <button class="btn success" onclick="crearProyecto()">Crear Proyecto</button>
      </div>
    </section>

  </main>
</div>

<div class="toast" id="toastBox">
  <strong id="toastTitle">Aviso</strong>
  <p id="toastMsg"></p>
</div>

<!-- Modal para subir archivo -->
<div id="modalUpload" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; 
     background:rgba(0,0,0,0.7); z-index:1000; padding:40px;">
  <div class="card" style="max-width:500px; margin:auto;">
    <h3>Subir Memoria TÃ©cnica (PDF)</h3>
    <p style="color:var(--muted); font-size:13px;">
      Proyecto: <strong id="modalProyectoNombre"></strong>
    </p>
    <input type="file" id="fileUpload" accept=".pdf" class="input">
    <div style="height:10px"></div>
    <button class="btn success" onclick="subirArchivo()">Subir</button>
    <button class="btn" onclick="cerrarModal()">Cancelar</button>
  </div>
</div>

<script src="assets/js/api.js"></script>
<script src="assets/js/ui.js"></script>
<script>initTheme();</script>
<script>
requireAuth('tutor');

let cache = {
  promociones: [],
  especialidades: [],
  proyectos: [],
  promocionActual: null,
  especialidadActual: null,
  proyectoIdUpload: null
};

function setActive(btnId){
  ['navHome','navProyectos','navCrear'].forEach(id=>$(id).classList.remove('active'));
  $(btnId).classList.add('active');
}

function show(section){
  ['home','proyectos','crear'].forEach(s=>$(s).style.display='none');
  $(section).style.display='block';
  setActive('nav' + section.charAt(0).toUpperCase() + section.slice(1).replace('home','Home'));
}

async function loadInicial(){
  try{
    // Cargar promociones
    cache.promociones = await apiFetch('/tutores/promociones');
    
    // Cargar especialidades
    cache.especialidades = await apiFetch('/tutores/especialidades');
    
    // Cargar estadÃ­sticas
    const stats = await apiFetch('/tutores/estadisticas');
    $('kpiPromos').textContent = stats.total_promociones;
    $('kpiProy').textContent = stats.total_proyectos;
    $('kpiFiles').textContent = stats.proyectos_con_archivo;

    // Llenar selectores
    llenarSelectores();

  }catch(err){
    toast('Error', err.message);
  }
}

function llenarSelectores(){
  // Selector de filtros (proyectos)
  const htmlPromos = cache.promociones.map(p => `
    <option value="${p.id}">${p.anio}</option>
  `).join('');
  
  const htmlEsps = cache.especialidades.map(e => `
    <option value="${e.id}">${escapeHtml(e.nombre)}</option>
  `).join('');

  $('promocionSel').innerHTML = '<option value="">Seleccionar...</option>' + htmlPromos;
  $('especialidadSel').innerHTML = '<option value="">Seleccionar...</option>' + htmlEsps;

  // Selector de crear proyecto
  $('promocionNuevo').innerHTML = '<option value="">Seleccionar...</option>' + htmlPromos;
  $('especialidadNuevo').innerHTML = '<option value="">Seleccionar...</option>' + htmlEsps;
}

async function cargarProyectos(){
  try{
    const promocionId = $('promocionSel').value;
    const especialidadId = $('especialidadSel').value;

    if (!promocionId || !especialidadId) {
      $('filtrosInfo').innerHTML = '<span class="badge warn">Selecciona promociÃ³n y especialidad</span>';
      $('tblProy').querySelector('tbody').innerHTML = '';
      $('hint').textContent = 'Selecciona filtros para ver proyectos';
      $('btnDescargar').disabled = true;
      return;
    }

    cache.promocionActual = cache.promociones.find(p => String(p.id) === promocionId);
    cache.especialidadActual = cache.especialidades.find(e => String(e.id) === especialidadId);

    $('filtrosInfo').innerHTML = `
      <div class="badge">${cache.promocionActual.anio}</div>
      <div style="height:4px"></div>
      <div class="badge info">${escapeHtml(cache.especialidadActual.nombre)}</div>
    `;

    // Cargar proyectos
    cache.proyectos = await apiFetch(`/tutores/proyectos/${promocionId}/${especialidadId}`);

    renderTabla();
    show('proyectos');
    $('btnDescargar').disabled = false;

  }catch(err){
    toast('Error', err.message);
  }
}

function renderTabla(){
  const q = $('q').value.trim().toLowerCase();

  const rows = cache.proyectos.filter(x => {
    const s = `${x.tema_proyecto||''} ${x.descripcion||''} ${x.estado||''}`.toLowerCase();
    return s.includes(q);
  });

  const tbody = $('tblProy').querySelector('tbody');
  tbody.innerHTML = rows.map(x => {
    const hasFile = !!x.nombre_archivo;

    const archivoCell = hasFile
      ? `<div>
           <div class="badge">${escapeHtml(x.nombre_visible || 'Memoria TÃ©cnica')}</div>
           <div style="height:6px"></div>
           <a class="badge" target="_blank"
              href="/uploads/${encodeURIComponent(x.nombre_archivo)}">
              Ver PDF
           </a>
         </div>`
      : `<button class="btn success" onclick="abrirModalUpload(${x.proyecto_id}, '${escapeHtml(x.tema_proyecto)}')">
           Subir PDF
         </button>`;

    const notaVal = (x.calificacion ?? '');
    const obsVal = (x.observaciones ?? '');

    return `
      <tr>
        <td><strong>${escapeHtml(x.tema_proyecto)}</strong></td>
        <td>${statusBadge(x.estado)}</td>
        <td>${archivoCell}</td>
        <td>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <input class="input" style="width:110px;"
                   id="nota_${x.proyecto_id}"
                   placeholder="Nota"
                   value="${escapeHtml(notaVal)}"/>
            <input class="input" style="flex:1; min-width:160px;"
                   id="obs_${x.proyecto_id}"
                   placeholder="Observaciones"
                   value="${escapeHtml(obsVal)}"/>
            <button class="btn success" onclick="guardarNota(${x.proyecto_id})">
              Guardar
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');

  $('hint').textContent = rows.length
    ? `Mostrando ${rows.length} proyecto(s).`
    : 'No hay proyectos con esos filtros.';
}

function abrirModalUpload(proyectoId, nombreProyecto){
  cache.proyectoIdUpload = proyectoId;
  $('modalProyectoNombre').textContent = nombreProyecto;
  $('modalUpload').style.display = 'block';
}

function cerrarModal(){
  $('modalUpload').style.display = 'none';
  cache.proyectoIdUpload = null;
  $('fileUpload').value = '';
}

async function subirArchivo(){
  try{
    const file = $('fileUpload').files[0];
    if(!file) return toast('Error', 'Selecciona un archivo PDF');

    const formData = new FormData();
    formData.append('archivo', file);
    formData.append('proyecto_id', cache.proyectoIdUpload);

    const resp = await fetch(`${API_BASE}/archivo-final`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${getToken()}` },
      body: formData
    });

    if(!resp.ok) throw new Error('Error al subir archivo');

    toast('Ã‰xito âœ…', 'Memoria tÃ©cnica subida correctamente');
    cerrarModal();
    await cargarProyectos();

  }catch(err){
    toast('Error', err.message);
  }
}

async function guardarNota(proyectoId){
  try{
    const calificacion = $(`nota_${proyectoId}`).value.trim();
    const observaciones = $(`obs_${proyectoId}`).value.trim();

    if(!calificacion) return toast('Falta nota', 'Escribe la calificaciÃ³n');

    await apiFetch('/notas', {
      method:'POST',
      body:{ proyecto_id: proyectoId, calificacion, observaciones }
    });

    toast('Guardado âœ…', 'Nota guardada/actualizada');
    await cargarProyectos();

  }catch(err){
    toast('Error', err.message);
  }
}

async function crearProyecto(){
  try{
    const promocion_id = $('promocionNuevo').value;
    const especialidad_id = $('especialidadNuevo').value;
    const titulo = $('tituloNuevo').value.trim();
    const descripcion = $('descripcionNuevo').value.trim();

    if(!promocion_id || !especialidad_id || !titulo) {
      return toast('Error', 'Completa los campos requeridos');
    }

    await apiFetch('/proyectos', {
      method: 'POST',
      body: { promocion_id, especialidad_id, titulo, descripcion }
    });

    toast('Ã‰xito âœ…', 'Proyecto creado correctamente');
    $('tituloNuevo').value = '';
    $('descripcionNuevo').value = '';
    
    await loadInicial();
    show('proyectos');

  }catch(err){
    toast('Error', err.message);
  }
}

async function descargarMemoriasTecnicas(){
  if(!cache.promocionActual || !cache.especialidadActual) return;
  
  window.open(
    `/api/descargas/pdfs/${cache.especialidadActual.id}/${cache.promocionActual.id}`, 
    '_blank'
  );
}

function escapeHtml(str){
  return String(str || '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

loadInicial();
</script>
</body>
</html>